<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Complaint Details</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin_styles.css">
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Complaint Admin</h2>
        </div>
        <ul class="sidebar-nav">
            <li class="nav-item"><a href="/admin/dashboard.html" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>Dashboard</a></li>
            <li class="nav-item"><a href="/admin/complaints.html" class="nav-link active"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>Complaints</a></li>
            <li class="nav-item"><a href="/admin/users.html" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>Users</a></li>
            <li class="nav-item"><a href="/admin/categories.html" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>Categories</a></li>
            <li class="nav-item"><a href="/admin/departments.html" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>Departments</a></li>
            <li class="nav-item"><a href="/admin/settings.html" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>Settings</a></li>
        </ul>
        <div class="sidebar-footer">
            <a href="#" id="admin-logout-btn" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>Logout</a>
        </div>
    </div>
    <div class="main-content">
        <h1 id="complaint-title"></h1>
        <div class="form-container" style="margin-bottom: 2rem;">
            <p><strong>User:</strong> <span id="complaint-user"></span></p>
            <p><strong>Department:</strong> <span id="complaint-department"></span></p>
            <p><strong>Description:</strong></p>
            <p id="complaint-description"></p>
        </div>

        <div class="form-container" style="margin-bottom: 2rem;">
            <h2>Action Panel</h2>
            <form id="update-complaint-form">
                <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" name="status" class="form-control">
                        <option value="New">New</option>
                        <option value="In Review">In Review</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Resolved">Resolved</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="priority">Priority:</label>
                    <select id="priority" name="priority" class="form-control">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assignedTo">Assign To:</label>
                    <select id="assignedTo" name="assignedTo" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label for="publicResponse">Public Response:</label>
                    <textarea id="publicResponse" name="publicResponse" rows="4" class="form-control"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Update Complaint</button>
            </form>
        </div>

        <div class="form-container">
            <h2>Internal Notes</h2>
            <ul id="internal-notes-list" style="list-style: none; padding: 0; margin-bottom: 1rem;"></ul>
            <form id="add-note-form">
                <div class="form-group">
                    <textarea id="note" name="note" rows="3" class="form-control" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Add Note</button>
            </form>
        </div>
    </div>
    <script>
        const token = sessionStorage.getItem('token');
        if (!token) {
            window.location.href = '/index.html';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const complaintId = urlParams.get('id');

        const fetchComplaint = async () => {
            const response = await fetch(`/admin/complaints/${complaintId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const complaint = await response.json();

            document.getElementById('complaint-title').textContent = complaint.title;
            document.getElementById('complaint-user').textContent = complaint.user ? complaint.user.username : 'N/A';
            document.getElementById('complaint-department').textContent = complaint.department;
            document.getElementById('complaint-description').textContent = complaint.description;
            document.getElementById('status').value = complaint.status;
            document.getElementById('priority').value = complaint.priority;
            document.getElementById('publicResponse').value = complaint.publicResponse || '';

            await fetchUsers();
            if (complaint.assignedTo) {
                document.getElementById('assignedTo').value = complaint.assignedTo._id;
            }

            renderInternalNotes(complaint.internalNotes);
        };

        const renderInternalNotes = (notes) => {
            const notesList = document.getElementById('internal-notes-list');
            notesList.innerHTML = '';
            notes.forEach(note => {
                const li = document.createElement('li');
                li.textContent = `${note.note} - by ${note.author ? note.author.username : 'Unknown'} on ${new Date(note.createdAt).toLocaleString()}`;
                notesList.appendChild(li);
            });
        };

        const fetchUsers = async () => {
            const response = await fetch('/admin/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const users = await response.json();
            const assignedToSelect = document.getElementById('assignedTo');
            assignedToSelect.innerHTML = '<option value="">Unassigned</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user._id;
                option.textContent = user.username;
                assignedToSelect.appendChild(option);
            });
        };

        document.getElementById('update-complaint-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const response = await fetch(`/admin/complaints/${complaintId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('Complaint updated successfully');
                fetchComplaint();
            } else {
                alert('Failed to update complaint');
            }
        });

        document.getElementById('add-note-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const note = document.getElementById('note').value;
            const response = await fetch(`/admin/complaints/${complaintId}/notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ note })
            });
            if (response.ok) {
                fetchComplaint();
                document.getElementById('note').value = '';
            } else {
                alert('Failed to add note');
            }
        });

        fetchComplaint();
    </script>
    <script src="admin_script.js"></script>
</body>
</html>
